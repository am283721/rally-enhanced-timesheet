<!DOCTYPE html>
<html>
<head>
    <title>Rally Enhanced Timesheet</title>
    <!--  Build Date: Sun Jan 22 2023 11:44:59 GMT-0500 (Eastern Standard Time) -->
    <!--  Version: "0.2.0"-->
    <!--  Repository: "https:/github.com/am283721/rally-enhanced-timesheet"-->
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("TSUtilities",{singleton:!0,timeLockKeyPrefix:"rally.technicalservices.timesheet.weeklock",approvalKeyPrefix:"rally.technicalservices.timesheet.status",deletionKeyPrefix:"rally.technicalservices.timesheet.deletion",pinKeyPrefix:"rally.technicalservices.timesheet.pin",archiveSuffix:"~archived",loadWsapiRecords:function(e,t){let r=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge({model:"Defect",fetch:["ObjectID"]},e)).load({callback:function(e,i,n){n?t?r.resolve(i):r.resolve(e):r.reject("Problem loading: "+i.error.errors.join(". "))}}),r.promise},loadWsapiRecordsAsync(e,t){return this.wrap(this.loadWsapiRecords(e,t))},loadWsapiRecordsWithParallelPages:function(e,t){let r=Ext.create("Deft.Deferred"),i=this,n=Ext.clone(e);return n.limit=1,n.pageSize=1,n.fetch=["ObjectID"],this.loadWsapiRecords(n,!0).then({success:function(n){e.pageSize=200,e.limit=e.pageSize;let s=n.resultSet.totalRecords,o=Math.ceil(s/e.pageSize),l=[];Ext.Array.each(_.range(1,o+1),(function(r){let n=Ext.clone(e);n.currentPage=r,l.push((function(){let e=parseInt(100*r/o,10),s=t||"Loading values";return Rally.getApp().setLoading(s+" ("+e+"%)"),i.loadWsapiRecords(n)}))})),CA.techservices.promise.ParallelThrottle.throttle(l,6,i).then({success:function(e){r.resolve(Ext.Array.flatten(e))},failure:function(e){r.reject(e)}})},failure:function(e){r.reject(e)}}),r.promise},getPreferenceProject:function(){return Rally.getApp().getSetting("preferenceProjectRef")},isEditableProjectForCurrentUser:function(e,t){let r=t||Rally.getApp(),i=this;if(this.currentUserIsAdmin(t))return!0;let n=this._getOidFromRef(e);return Ext.Array.filter(r.getContext().getPermissions().userPermissions,(function(e){return("Editor"==e.Role||"ProjectAdmin"==e.Role)&&i._getOidFromRef(e._ref)==n})).length>0},getEditableProjectForCurrentUser:function(){let e=Rally.getApp();if(this._currentUserCanWrite())return e.getContext().getProjectRef();let t=this._getOidFromRef(e.getContext().getWorkspaceRef()),r=Ext.Array.filter(e.getContext().getPermissions().userPermissions,(function(e){if(Ext.isEmpty(e.Workspace))return!1;let r=this._getOidFromRef(e.Workspace);return t==r&&("Editor"==e.Role||"ProjectAdmin"==e.Role)}),this);return r.length>0&&r[0]._ref},_getOidFromRef:function(e){let t=e.replace(/\.js$/,"").split(/\//);return t[t.length-1].replace(/\.js/,"")},currentUserIsAdmin:function(e){let t=e||Rally.getApp();if(this.currentUserIsSubAdmin())return!0;let r=t.getContext().getPermissions().userPermissions,i=Ext.Array.filter(r,(function(e){return"Workspace Admin"==e.Role||"Subscription Admin"==e.Role})),n=t.getContext().getWorkspace()._ref,s=!1;return i.length>0&&Ext.Array.each(i,(function(e){n.replace(/\.js$/,"")==e._ref.replace(/\.js$/,"")&&(s=!0)})),s},currentUserIsSubAdmin:function(e){let t=(e||Rally.getApp()).getContext().getPermissions().userPermissions;return Ext.Array.filter(t,(function(e){return"Subscription Admin"==e.Role})).length>0},_currentUserCanWrite:function(){let e=Rally.getApp();if(e.getContext().getUser().SubscriptionAdmin)return!0;let t=e.getContext().getPermissions().userPermissions,r=Ext.Array.filter(t,(function(e){return"Workspace Admin"==e.Role||"Subscription Admin"==e.Role})),i=e.getContext().getWorkspace()._ref,n=!1;return r.length>0&&Ext.Array.each(r,(function(e){i.replace(/\.js$/,"")==e._ref.replace(/\.js$/,"")&&(n=!0)})),n},_currentUserCanUnapprove:function(){return this.currentUserIsAdmin()},async getCurrentUserIsTimeSheetAdmin(){const e=await this.wrap(Ext.create(Rally.data.wsapi.RefsToRecords).convert([Rally.getApp().getContext().getUser()._ref])).catch((()=>null));return!(!e||!e.length)&&!!e[0].get("c_TimesheetAdmin")},fetchPortfolioItemTypes(){return this.loadWsapiRecordsAsync({model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]})},fetchField:function(e,t){let r=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:e,success:function(e){r.resolve(e.getField(t))},failure:function(){r.reject("Could not load schedule states")}}),r.promise},wrap(e){return e&&_.isFunction(e.then)?new Promise(((t,r)=>{e.then({success(...e){t(...e)},failure(e){Rally.getApp().setLoading(!1),r(e)},scope:this})})):Promise.reject(new Error("Wrap cannot process this type of data into a ECMA promise"))}});
                Ext.define("TSDateUtils",{singleton:!0,getBeginningOfWeekForLocalDate:function(e,t){Ext.isEmpty(t)&&(t=0);let i=e.getDay();0===e.getUTCHours()&&(i=e.getUTCDay());let r=t-i;return i<t&&(r=t-i-7),Ext.Date.add(e,Ext.Date.DAY,r)},getBeginningOfWeekISOForLocalDate:function(e,t,i){Ext.isEmpty(i)&&(i=0);let r=TSDateUtils.getBeginningOfWeekForLocalDate(e,i);return t?Rally.util.DateTime.toIsoString(r).replace(/T.*$/,"T00:00:00.0Z"):0===r.getUTCHours()?Rally.util.DateTime.toIsoString(r,!0).replace(/T.*$/,""):Rally.util.DateTime.toIsoString(r,!1).replace(/T.*$/,"")},formatShiftedDate:function(e,t){let i=e.getTimezoneOffset();return i>0&&(e=Rally.util.DateTime.add(e,"minute",i)),Ext.util.Format.date(e,t)},pretendIMeantUTC:function(e,t){let i=e.getTimezoneOffset();return t?Rally.util.DateTime.toIsoString(e).replace(/T.*$/,"T00:00:00.000Z"):Rally.util.DateTime.add(e,"minute",-1*i)},isApproved:function(e,t){let i=Ext.create("Deft.Deferred"),r=e,a=t||Rally.getApp().getContext().getUser().ObjectID,n=Ext.String.format("{0}.{1}.{2}",TSUtilities.approvalKeyPrefix,r,a);return this._loadWeekStatusPreference(n).then({success:function(e){if(0===e.length)return void i.resolve(!1);let t=e[0].get("Value");if(/{/.test(t)){if("Approved"==Ext.JSON.decode(t).status)return void i.resolve(!0)}i.resolve(!1)},failure:function(e){i.reject(e)}}),i.promise},_loadWeekStatusPreference:function(e){let t={model:"Preference",limit:1,pageSize:1,filters:[{property:"Name",operator:"contains",value:e},{property:"Name",operator:"!contains",value:TSUtilities.archiveSuffix}],fetch:["Name","Value"],sorters:[{property:"CreationDate",direction:"DESC"}]};return TSUtilities.loadWsapiRecords(t)}});
                Ext.define("TSArrowedDate",{extend:"Ext.container.Container",alias:"widget.tsarroweddate",layout:"hbox",items:[{xtype:"rallybutton",itemId:"previous_button",cls:"secondary",ui:"tsnav",text:"<<"},{xtype:"rallydatefield",itemId:"date_field"},{xtype:"rallybutton",itemId:"next_button",cls:"secondary",ui:"tsnav",text:" >>"}],constructor:function(t){this.mergeConfig(t),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("change"),this.value&&this.down("rallydatefield").setValue(this.value),this.down("rallydatefield").on("change",this._onDateChanged,this),this.down("#previous_button").on("click",this._onPreviousButtonClicked,this),this.down("#next_button").on("click",this._onNextButtonClicked,this)},_onDateChanged:function(t,e,i){this.fireEvent("change",this,e,i)},setValue:function(t){this.down("rallydatefield").setValue(t)},getValue:function(){return this.down("rallydatefield").getValue()},_onPreviousButtonClicked:function(){let t=this.getValue();Ext.isEmpty(t)||this.setValue(Rally.util.DateTime.add(t,"day",-7))},_onNextButtonClicked:function(){let t=this.getValue();Ext.isEmpty(t)||this.setValue(Rally.util.DateTime.add(t,"day",7))}});
                Ext.define("Rally.technicalservices.ChooserDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tschooserdialog",clientMetrics:[{beginEvent:"beforeshow",endEvent:"show",description:"dialog shown"}],width:800,maxHeight:"100%",closable:!0,searchContext:"project",config:{title:"Choose an Artifact",artifactTypes:[],multiple:!1,storeConfig:{},filterableFields:[],columns:[],fetchFields:[],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0},items:{xtype:"panel",border:!1,items:[{xtype:"container",itemId:"gridContainer",layout:"fit",height:400}]},constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("artifactChosen"),this.addCls("chooserDialog"),this._buildButtons(),this._buildSearchBar(),Rally.data.ModelFactory.getModels({types:this.artifactTypes,success:function(e){this.models=e,this.artifactTypes.length>1&&this._setupComboBox(e),this._buildGrid(e[this.artifactTypes[0]])},scope:this})},_buildButtons:function(){this.down("panel").addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",text:this.selectionButtonText,cls:"primary small",scope:this,userAction:"clicked done in dialog",handler:function(){let e=this._getSelectedRecords();this.multiple||(e=e[0]),this.fireEvent("artifactChosen",this,e),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary small",handler:this.close,scope:this,ui:"link"}]})},_buildSearchBar:function(){let e=Ext.create("Ext.form.field.ComboBox",{itemId:"filterTypeComboBox",queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["attributeName","displayName"],data:this.filterableFields}),displayField:"displayName",valueField:"attributeName",editable:!1});e.select(e.getStore().getAt(1)),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",items:[e,{xtype:"textfield",itemId:"searchTerms",emptyText:"enter search terms",flex:1,enableKeyEvents:!0,listeners:{keyup:function(e,t){t.getKey()===Ext.EventObject.ENTER&&this._search()},scope:this}},{xtype:"button",text:'<span class="icon-search"> </span>',handler:this._openSearchMenu,scope:this}]}),e.on("change",this._changeSearchField,this)},_changeSearchField:function(e){let t=e.getValue(),i=this.models[this.artifactTypes[0]].getField(t),s={xtype:"textfield",enableKeyEvents:!0,listeners:{keyup:function(e,t){t.getKey()===Ext.EventObject.ENTER&&this._search()},scope:this}};i&&i.editor&&i.editor.field&&(s=i.editor.field,delete s.storeConfig,s.defaultToCurrentTimebox=!0,s.autoSelectCurrentItem=!0,"rallytextfield"==s.xtype?(s.enableKeyEvents=!0,s.listeners={keyup:function(e,t){t.getKey()===Ext.EventObject.ENTER&&this._search()},scope:this}):s.listeners={scope:this,change:this._search,select:this._search});let o=Ext.Object.merge({itemId:"searchTerms",emptyText:"enter search terms",flex:1},s),l=this.down("#searchBar").items.length-2;this.down("#searchTerms")&&this.down("#searchTerms").destroy(),this.down("#searchBar").insert(l,o)},_setupComboBox:function(e){let t=this.down("#searchBar"),i=Ext.create("Ext.form.field.ComboBox",{xtype:"combo",name:"filterType",queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["typeName","displayName","wsapiModel"]}),displayField:"displayName",valueField:"typeName",editable:!1});t.insert(0,i),Ext.Object.each(e,(function(e,t){i.getStore().add({typeName:t.typePath,displayName:t.displayName,wsapiModel:t})}),this),i.select(i.getStore().getAt(0)),i.on("select",(function(e,t){let i=t[0];this.grid.reconfigureWithModel(i.get("wsapiModel"))}),this)},_buildGrid:function(e){let t=this.multiple?"MULTI":"SINGLE";this.selectionModel=Ext.create("Rally.ui.selection.CheckboxModel",{mode:t,allowDeselect:!0});let i=this.storeConfig;i.context={project:Rally.getApp().getContext().getProjectRef()};let s=Ext.Array.merge(["ObjectID"],this.fetchFields),o=i.fetch||[];i.fetch=Ext.Array.merge(s,o);let l=Ext.Object.merge({model:e,selModel:this.selectionModel,autoAddAllModelFieldsAsColumns:!1,enableEditing:!1,enableColumnHide:!1,enableColumnMove:!1,columnCfgs:this.columns,storeConfig:i,showRowActionsColumn:!1,viewConfig:{emptyText:Rally.ui.EmptyTextFactory.get("defaultText")}},this.config.gridConfig);this.grid=Ext.create("Rally.ui.grid.Grid",l),this.mon(this.grid,"load",this._onGridLoad,this),this.down("#gridContainer").add(this.grid),this._onGridReady()},_onGridReady:function(){this.grid.rendered?this.grid.getStore().isLoading()?this.mon(this.grid,"load",this._onGridReady,this,{single:!0}):(this._onGridLoad(),this.down("#gridContainer").setHeight(Math.min(Rally.getApp().getHeight()-125,400)),this.center(),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)):this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0})},_onGridLoad:function(){if(this.getSelectedRef()){let e=this.grid.getStore().find("_ref",this.getSelectedRef());if(-1!==e){let t=this.grid.getStore().getAt(e);this.grid.getSelectionModel().select(t)}}},_getSelectedRecords:function(){return this.selectionModel.getSelection()},_search:function(){let e,t=this.down("#searchTerms").getValue(),i=this.down("#filterTypeComboBox").getValue(),s=this.grid.storeConfig;s.context={project:Rally.getApp().getContext().getProjectRef()},"workspace"==this.searchContext&&(s.context={project:null}),this.grid.getStore().context=s.context,Ext.isEmpty(t)||(e=Ext.create("Rally.data.wsapi.Filter",{property:i,value:t,operator:"Contains"})),Ext.isFunction(this.down("#searchTerms").getQueryFromSelected)&&(e=this.down("#searchTerms").getQueryFromSelected()),this.grid.filter(e,!0)},_openSearchMenu:function(e){Ext.widget({xtype:"rallymenu",items:[{text:"Search Selected Project",handler:function(){this.searchContext="project",this._search()},scope:this},{text:"Search Everywhere",handler:function(){this.searchContext="workspace",this._search()},scope:this}]}).showBy(e.getEl()),e.toolTip&&e.toolTip.hide()}});
                Ext.define("CA.technicalservices.ColumnPickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tscolumnpickerdialog",width:200,closable:!0,config:{title:"Choose Columns",multiple:!0,pickableColumns:[],selectionButtonText:"Apply"},items:[{xtype:"panel",border:!1,items:[{xtype:"container",itemId:"grid_container",layout:"fit",height:325}]}],constructor:function(t){this.mergeConfig(t),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("columnschosen"),this._buildButtons(),this._buildGrid()},_buildButtons:function(){this.down("panel").addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",text:this.selectionButtonText,cls:"primary small",scope:this,userAction:"clicked done in dialog",handler:function(){let t=this.getRecordsWithSelection();this.fireEvent("columnschosen",this,t),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary small",handler:this.close,scope:this,ui:"link"}]})},_buildGrid:function(){let t=this.multiple?"MULTI":"SINGLE";this.selectionModel=Ext.create("Rally.ui.selection.CheckboxModel",{mode:t,allowDeselect:!0});let e=this.pickableColumns,i=Ext.create("Rally.data.custom.Store",{data:this.pickableColumns});this.grid=Ext.create("Rally.ui.grid.Grid",{selModel:this.selectionModel,enableColumnHide:!1,enableColumnMove:!1,columnCfgs:this._getGridColumns(),showPagingToolbar:!1,showRowActionsColumn:!1,store:i,listeners:{viewready:function(t){let i=t.getSelectionModel();Ext.Array.each(e,(function(e,o){e.hidden||i.select(t.store.data.items[o],!0)}))}}}),this.down("#grid_container").add(this.grid)},_getGridColumns:function(){return[{dataIndex:"text",flex:1}]},getRecordsWithSelection:function(){let t=this.grid.getSelectionModel().getSelection(),e={};return Ext.Array.each(t,(function(t){e[t.get("text")]=t.getData()})),Ext.Array.each(this.pickableColumns,(function(t){t.hidden=Ext.isEmpty(e[t.text])})),this.pickableColumns}});
                Ext.define("CA.technicalservices.ColumnPickerButton",{extend:"Rally.ui.Button",requires:["CA.technicalservices.ColumnPickerDialog"],alias:"widget.tscolumnpickerbutton",config:{pickableColumns:[],text:'<span class="icon-add-column"> </span>',cls:"secondary"},constructor:function(n){this.mergeConfig(n),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("columnschosen")},afterRender:function(){this.callParent(arguments),this.mon(this.el,this.clickEvent,this._showDialog,this)},_showDialog:function(){let n=this;Ext.create("CA.technicalservices.ColumnPickerDialog",{autoShow:!0,pickableColumns:this.pickableColumns,listeners:{scope:this,columnschosen:function(i,t){this.fireEvent("columnschosen",n,t)}}})}});
                Ext.define("CA.technicalservices.TimeDetailsDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tstimedetailsdialog",closable:!0,layout:"border",currentDay:null,timeBlocks:[],config:{title:"Time Details",row:null,autoShow:!0,height:400,width:600},items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",itemId:"daysContainer",layout:"vbox",width:150},{xtype:"container",itemId:"dayContainer",width:450}]}],constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.currentDay=(new Date).getDay(),this._buildDays(),this._buildForm()},_buildDays:function(){let e=this,t=CA.techservices.timesheet.TimeRowUtils.daysInOrder,a=this.down("#daysContainer");this.day_boxes={},Ext.Array.each(t,(function(t){e.day_boxes[t]=a.add({item_id:"day_box_"+t,xtype:"container",margin:10,tpl:'<span class="day_name">{day}</span>: <span class="day_value">{value}</day>'});let i=e._getHoursForDay(t);e.day_boxes[t].update({day:t,value:i})}))},_getHoursForDay:function(e){let t=this.row.getTimeEntryValue(e),a=0;return Ext.isEmpty(t)||(a=t.get("Hours")),a},_buildForm:function(){let e=this.down("#dayContainer");this._buildNavigation(e),e.add({xtype:"container",itemId:"detailsPanel",layout:"vbox",width:"100%",height:275,padding:3}),this._updateDetailsPanel(),this._addAddButton(e)},_buildNavigation:function(e){let t=e.add({xtype:"container",layout:"hbox"});t.add({xtype:"rallybutton",text:'<span class="icon-left"> </span>',cls:"secondary small",listeners:{scope:this,click:this._moveLeft}}),t.add({xtype:"container",flex:1}),t.add({xtype:"container",tpl:"{day}",itemId:"day_selector_display"}).update({day:CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay]}),t.add({xtype:"container",flex:1}),t.add({xtype:"rallybutton",text:'<span class="icon-right"> </span>',cls:"secondary small",listeners:{scope:this,click:this._moveRight}})},_moveLeft:function(){this.currentDay=this.currentDay-1,this.currentDay<0&&(this.currentDay=6),this.down("#day_selector_display").update({day:CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay]}),this._updateDetailsPanel()},_moveRight:function(){this.currentDay=this.currentDay+1,this.currentDay>6&&(this.currentDay=0),this.down("#day_selector_display").update({day:CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay]}),this._updateDetailsPanel()},_updateDetailsPanel:function(){let e=this.down("#detailsPanel");e.removeAll();let t=this.row.getTimeBlocks(CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay]);e.add({xtype:"container",itemId:"time_block_container",flex:1,layout:"vbox"}),this.timeBlocks=[],Ext.isEmpty(t)||Ext.Array.each(t,(function(e){this._addTimeBlock(e)}),this);let a=this._getHoursForDay(CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay])-this._getTotal();a<0&&(a=0),this._addDailyAdjustmentBox(e,a),this._enableDisableAddButton()},_addAddButton:function(e){let t=e.add({xtype:"container",layout:"hbox",width:"100%",padding:10});t.add({xtype:"container",flex:1}),t.add({xtype:"rallybutton",itemId:"add_block_button",cls:"small secondary",text:"+",listeners:{scope:this,click:function(e){this._addTimeBlock()}}})},_addDailyAdjustmentBox:function(e,t){let a=e.add({xtype:"container",layout:"hbox",width:"100%",margin:7});a.add({xtype:"container",flex:1}),a.add({itemId:"adjustment_box",xtype:"rallynumberfield",value:t,labelWidth:75,width:130,fieldLabel:"Adjustment:",maxValue:36,minValue:0}).on("change",this._recalculateTotal,this)},_removeTimeBlock:function(e,t){Ext.Array.each(t.reverse(),(function(e){e.setValue(0)})),this.row.removeTimeBlock(CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay],e.itemId),e.destroy(),this._enableDisableAddButton()},_addTimeBlock:function(e){let t=this.down("#time_block_container"),a=(new Date).getTime();Ext.isEmpty(e)||(a=e.id);let i=t.add({xtype:"container",layout:"hbox",itemId:a,defaults:{margin:3}}),l=[{display:"12A",value:0},{display:"1 A",value:1},{display:"2 A",value:2},{display:"3 A",value:3},{display:"4 A",value:4},{display:"5 A",value:5},{display:"6 A",value:6},{display:"7 A",value:7},{display:"8 A",value:8},{display:"9 A",value:9},{display:"10A",value:10},{display:"11A",value:11},{display:"12P",value:12},{display:"1 P",value:13},{display:"2 P",value:14},{display:"3 P",value:15},{display:"4 P",value:16},{display:"5 P",value:17},{display:"6 P",value:18},{display:"7 P",value:19},{display:"8 P",value:20},{display:"9 P",value:21},{display:"10P",value:22},{display:"11P",value:23}],d=Ext.create("Rally.data.custom.Store",{fields:["display","value"],data:Ext.clone(l)}),n=Ext.create("Rally.data.custom.Store",{fields:["display","value"],data:Ext.clone(l)}),s=new Date,o={xtype:"rallycombobox",itemId:"start_hour",fieldLabel:" ",allowNoEntry:!1,store:d,queryMode:"local",displayField:"display",valueField:"value",width:95,labelWidth:30,value:s.getHours()},u={xtype:"rallynumberfield",itemId:"start_minute",fieldLabel:"  ",maxValue:59,minValue:0,width:55,labelWidth:5,value:s.getMinutes()},r={xtype:"rallycombobox",itemId:"end_hour",allowNoEntry:!0,noEntryText:" ",noEntryValue:null,fieldLabel:"to",store:n,queryMode:"local",displayField:"display",valueField:"value",width:85,labelWidth:20},c={xtype:"rallynumberfield",itemId:"end_minute",fieldLabel:"  ",maxValue:59,minValue:0,width:55,labelWidth:5};o.value=(new Date).getHours(),u.value=(new Date).getMinutes(),Ext.isEmpty(e)||(o.value=e.start_hour,u.value=e.start_minute,r.value=e.end_hour,c.value=e.end_minute);let y=[i.add(o),i.add(u),i.add(r),i.add(c)];i.add({xtype:"container",flex:1}),i.add({xtype:"rallynumberfield",itemId:"block_total",fieldLabel:" = ",labelSeparator:"",editable:!1,maxValue:36,minValue:0,spinDownEnabled:!1,spinUpEnabled:!1,width:65,labelWidth:5}),i.add({xtype:"rallybutton",itemId:"remove_block_button",cls:"no-border",text:'<span class="icon-cancel"> </span>',listeners:{scope:this,click:function(e){this._removeTimeBlock(i,y)}}}),Ext.Array.each(y,(function(e){e.on("change",(function(){this._setValidBlockValues(i)}),this),e.on("change",(function(){this._updateRow(i)}),this),e.on("change",(function(){this._updateBlockTotal(i)}),this),e.on("change",this._recalculateTotal,this)}),this),this.timeBlocks.push(i),this._setValidBlockValues(i),this._updateRow(i),this._updateBlockTotal(i)},_setValidBlockValues:function(e){let t=e.down("#start_hour").getValue(),a=(e.down("#start_minute").getValue(),e.down("#end_hour").getValue());e.down("#end_minute").getValue();if(Ext.isEmpty(t))return;let i=e.down("#end_hour").getStore();i.clearFilter(!0),i.addFilter({property:"value",operator:">=",value:t}),Ext.isEmpty(a)||t>a&&e.down("#end_hour").setValue("")},_updateBlockTotal:function(e){let t=e.down("#start_hour").getValue(),a=e.down("#start_minute").getValue(),i=e.down("#end_hour").getValue(),l=e.down("#end_minute").getValue();e.down("#block_total").setValue(0);let d=0;if(!Ext.isEmpty(t)&&!Ext.isEmpty(i)){let e=new Date(1999,1,1,t,a||0),n=new Date(1999,1,1,i,l||0);d=Rally.util.DateTime.getDifference(n,e,"minute")/60}e.down("#block_total").setValue(d),this._enableDisableAddButton()},_updateRow:function(e){this.row.addTimeBlock(CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay],{id:e.getItemId(),start_hour:e.down("#start_hour").getValue(),start_minute:e.down("#start_minute").getValue(),end_hour:e.down("#end_hour").getValue(),end_minute:e.down("#end_minute").getValue()}),this.row.save()},_enableDisableAddButton:function(){if(!this.down("#add_block_button"))return;let e=!1;Ext.Array.each(this.timeBlocks,(function(t){if(!t.down("#block_total"))return;(t.down("#block_total").getValue()||0)<=0&&(e=!0)})),this.down("#add_block_button").setDisabled(e)},_getTotal:function(){let e=0;Ext.Array.each(this.timeBlocks,(function(t){if(!Ext.isEmpty(t)){let a=t.down("#block_total")&&t.down("#block_total").getValue()||0;e+=a}}));let t=this.down("#adjustment_box");if(!Ext.isEmpty(t)){let a=t.getValue()||0;e+=a}return e},_recalculateTotal:function(){let e=Ext.util.Format.number(this._getTotal(),"#.##"),t=CA.techservices.timesheet.TimeRowUtils.daysInOrder[this.currentDay];this.day_boxes[t].update({day:t,value:e}),this.row.set(t,parseFloat(e,10)),this.row.save()}});
                Ext.define("CA.techservices.timesheet.TimeRowUtils",{singleton:!0,daysInOrder:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayShortNames:{Sunday:"Sun",Monday:"Mon",Tuesday:"Tues",Wednesday:"Wed",Thursday:"Thur",Friday:"Fri",Saturday:"Sat"},getDayOfWeekFromDate:function(e){return 0===e.getUTCHours()?e.getUTCDay():e.getDay()},detailKeyPrefix:"ca.technicalservices.timesheet.details",getDetailPrefix:function(e){return Ext.isDate(e)&&(e=Rally.util.DateTime.toIsoString(e).replace(/T.*$/,"")),Ext.String.format("{0}.{1}",CA.techservices.timesheet.TimeRowUtils.detailKeyPrefix,e)},getDayOfWeek:function(e,t){let r=t.get("WeekStartDate");return Ext.isEmpty(r)?0:CA.techservices.timesheet.TimeRowUtils.getDayOfWeekFromDate(r)},getFieldFromTimeEntryItems:function(e,t,r){if(!Ext.isEmpty(e))return e;let i=t.get("TimeEntryItemRecords");if(Ext.isEmpty(i))return e;if(!Ext.isArray(i)||0===i.length)return e;if(/\./.test(r)){let e=r.split("."),t=e.shift();if(1==e.length)return Ext.isEmpty(i[0].get(t))?null:i[0].get(t)[e[0]];if(2==e.length)return Ext.isEmpty(i[0].get(t))||Ext.isEmpty(i[0].get(t)[e[0]])?null:i[0].get(t)[e[0]][e[1]];console.log("Field Array Too Long",e)}return i[0].get(r)},getDayValueFromTimeEntryValues:function(e,t,r){if(!Ext.isEmpty(e))return e;let i=Ext.Array.indexOf(CA.techservices.timesheet.TimeRowUtils.daysInOrder,r),s=t.get("WeekStartDate");if(Ext.isEmpty(s))return 0;let n=Rally.util.DateTime.add(s,"week",1),a=t.get("TimeEntryValueRecords"),o=0;return Ext.Array.each(a,(function(e){let t=e.get("DateVal").getUTCDay(),r=e.get("DateVal");t==i&&r>=s&&r<n&&(o=e.get("Hours"))})),o||0},getTotalFromDayValues:function(e,t){let r=0;return Ext.Array.each(CA.techservices.timesheet.TimeRowUtils.daysInOrder,(function(e){let i=t.get(e)||0;r=100*i+r})),Math.round(r)/100},getOrderedDaysBasedOnWeekStart:function(e){if(0===e)return CA.techservices.timesheet.TimeRowUtils.daysInOrder;let t=CA.techservices.timesheet.TimeRowUtils.daysInOrder,r=Ext.Array.slice(t,e,7),i=Ext.Array.slice(t,0,e);return Ext.Array.push(r,i)},getValueFromDayOfWeek:function(e,t,r){let i=CA.techservices.timesheet.TimeRowUtils.getOrderedDaysBasedOnWeekStart(t),s=Ext.Array.indexOf(i,r);return 0===moment(e).hours()?moment(e).add(s,"days").toDate():moment(e).utc().add(s,"days").toDate()},getBlocksFromDetailPreference:function(e,t){if(!Ext.isEmpty(e))return e;let r=t.get("DetailPreference");if(Ext.isEmpty(r))return{};let i=r.get("Value");return Ext.isEmpty(i)?{}:/{/.test(i)?Ext.JSON.decode(i):{}},getItemOIDFromTimeEntryItem:function(e){let t=-1,r=e.get("WorkProduct"),i=e.get("Task");return Ext.isEmpty(r)||(t=r.ObjectID),Ext.isEmpty(i)||(t=i.ObjectID),t},getDetailPreference:function(e){return Deft.Chain.sequence([function(){let t=Ext.create("Deft.Deferred");if(!Ext.isEmpty(e.get("DetailPreference")))return[e.get("DetailPreference")];let r=e.get("TaskOID");r<0&&(r=e.get("WorkProductOID"));let i=CA.techservices.timesheet.TimeRowUtils.getDetailPrefix(e.get("WeekStartDate")),s=Ext.String.format("{0}.{1}",i,r);return Rally.data.ModelFactory.getModel({type:"Preference",success:function(r){Ext.create(r,{Name:s,Value:"{}",User:Rally.getApp().getContext().getUser()._ref,Project:null}).save({callback:function(r,i){i.wasSuccessful()&&(e.set("DetailPreference",r),t.resolve(r))}})}}),t.promise}])},loadWsapiRecords:function(e,t){let r=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge({model:"Preference",fetch:["ObjectID"]},e)).load({callback:function(e,i,s){s?t?r.resolve(i):r.resolve(e):r.reject("Problem loading: "+i.error.errors.join(". "))}}),r.promise}}),Ext.define("CA.techservices.timesheet.TimeRow",{extend:"Ext.data.Model",createTEVProcess:{},fields:[{name:"__SecretKey",type:"string"},{name:"Pinned",type:"boolean",defaultValue:!1},{name:"Project",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Project")}},{name:"Task",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task")||""}},{name:"TaskOID",type:"number",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task");return Ext.isEmpty(r)?-1:r.ObjectID||-1}},{name:"TaskFID",type:"string",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task");return Ext.isEmpty(r)?-1:r.FormattedID||-1}},{name:"TaskName",type:"string",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task");return Ext.isEmpty(r)?"":r.Name||""}},{name:"User",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"User")}},{name:"WeekStartDate",type:"date"},{name:"WorkProduct",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct")||""}},{name:"WorkProductOID",type:"number",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct");return Ext.isEmpty(r)?-1:r.ObjectID||-1}},{name:"WorkProductFID",type:"string",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct");return Ext.isEmpty(r)?"":r.FormattedID||""}},{name:"WorkProductName",type:"string",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct");return Ext.isEmpty(r)?"":r.Name||""}},{name:"WorkProductState",type:"string",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.State")||"--"}},{name:"WorkProductPriority",type:"string",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.Priority")||CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.c_Priority")}},{name:"PortfolioItem",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.PortfolioItem")||""}},{name:"PortfolioItemOID",type:"number",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.PortfolioItem");return Ext.isEmpty(r)?-1:r.ObjectID||-1}},{name:"PortfolioItemFID",type:"string",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.PortfolioItem");return Ext.isEmpty(r)?"":r.FormattedID||""}},{name:"PortfolioItemName",type:"string",defaultValue:null,convert:function(e,t){let r=CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.PortfolioItem");return Ext.isEmpty(r)?"":r.Name||""}},{name:"Release",type:"string",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.Release")||CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task.Release")||""}},{name:"Iteration",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"WorkProduct.Iteration")||CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task.Iteration")||""}},{name:"ToDo",type:"number",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task.ToDo")}},{name:"Est",type:"number",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task.Estimate")}},{name:"State",type:"object",defaultValue:null,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getFieldFromTimeEntryItems(e,t,"Task.State")||""},sortType:function(e){return Ext.Array.indexOf(["Defined","In-Progress","Completed"],e)}},{name:"WeekStart",type:"int",convert:CA.techservices.timesheet.TimeRowUtils.getDayOfWeek},{name:"TimeEntryItemRecords",type:"object",defaultValue:[]},{name:"TimeEntryValueRecords",type:"object",defaultValue:[]},{name:"Sunday",type:"number",persist:!0,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Sunday")}},{name:"Monday",type:"number",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Monday")}},{name:"Tuesday",type:"number",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Tuesday")}},{name:"Wednesday",type:"number",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Wednesday")}},{name:"Thursday",type:"number",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Thursday")}},{name:"Friday",type:"number",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Friday")}},{name:"Saturday",type:"number",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getDayValueFromTimeEntryValues(e,t,"Saturday")}},{name:"Total",type:"number",defaultValue:0,convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getTotalFromDayValues(e,t)}},{name:"DetailPreference",type:"object",defaultValue:null},{name:"_DetailBlocks",type:"object",convert:function(e,t){return CA.techservices.timesheet.TimeRowUtils.getBlocksFromDetailPreference(e,t)}}],save:function(e){let t=this,r=this.getChanges(),i=[];return Ext.Object.each(r,(function(e,r){let s=CA.techservices.timesheet.TimeRowUtils.getValueFromDayOfWeek(t.get("WeekStartDate"),t.get("WeekStart"),e);Ext.Array.contains(CA.techservices.timesheet.TimeRowUtils.daysInOrder,e)&&((t._dateIsPrecedingMonth(s)||t._dateIsPrecedingWeek(s)&&!Rally.getApp().isTimeSheetAdmin())&&t._showClosedNotification(),i.push((function(){return t._changeDayValue(e,r)}))),"ToDo"===e&&i.push((function(){return t._changeToDoValue(r)})),"State"==e&&i.push((function(){return t._changeStateValue(r)})),"_DetailBlocks"===e&&i.push((function(){return t._changeDetailPreference(r)})),"WorkProductState"===e&&i.push((function(){return t._changeDefectStateValue(r)}))})),Deft.Chain.sequence(i,this)},_showClosedNotification:function(){Rally.ui.notify.Notifier.showWarning({message:"Warning: Creating time entry in a closed period - registrations will not be transferred to SAP"})},_changeToDoValue:function(e){return this._changeTaskFieldValue("ToDo",e)},_changeStateValue:function(e){return"Completed"===e&&this.set("ToDo",0),this._changeTaskFieldValue("State",e)},_changeTaskFieldValue:function(e,t){let r=Ext.create("Deft.Deferred"),i=this,s=this.get("Task");if(!Ext.isEmpty(s))return Rally.data.ModelFactory.getModel({type:"Task",scope:this,success:function(n){n.load(s.ObjectID,{fetch:["Name","State","Iteration","ToDo","WorkProduct"],callback:function(s,n){n.wasSuccessful()?(s.set(e,t),s.save({callback:function(e,t){i.set("Task",e.getData()),r.resolve(e)}})):r.reject("Problem saving Task")}})}}),r},_changeDefectStateValue:function(e){return this._changeDefectFieldValue("State",e)},_changeDefectFieldValue:function(e,t){let r=Ext.create("Deft.Deferred"),i=this,s=this.get("WorkProduct");if(!Ext.isEmpty(s))return Rally.data.ModelFactory.getModel({type:"Defect",scope:this,success:function(n){n.load(s.ObjectID,{fetch:["Name","State"],callback:function(s,n){n.wasSuccessful()?(s.set(e,t),s.save({callback:function(e,t){i.set("Defect",e.getData()),r.resolve(e)}})):r.reject("Problem saving Defect")}})}}),r},_changeDayValue:function(e,t){let r=Ext.create("Deft.Deferred"),i=this.getTimeEntryValue(e);return delete this.modified[e],Ext.isEmpty(i)?this._createTimeEntryValue(e,t):(i.set("Hours",t),this.set("Total",0),i.save({callback:function(e){r.resolve(e)}}),r.promise)},clearAndRemove:function(){let e=this,t=[];Rally.getApp().setLoading("Clearing..."),Ext.Array.each(CA.techservices.timesheet.TimeRowUtils.daysInOrder,(function(r){let i=e.getTimeEntryValue(r);Ext.isEmpty(i)||t.push((function(){let t=Ext.create("Deft.Deferred");return e.set(r,0),i.destroy({callback:function(e,r){t.resolve()}}),t.promise}))})),Deft.Chain.sequence(t).then({scope:this,success:function(t){this.set("TimeEntryValueRecords",[]),this.set("Total",0);let r=this.get("TimeEntryItemRecords"),i=Ext.Array.map(r,(function(t){return function(){return e._removeTimeEntryItem(t)}}));Deft.Chain.sequence(i).then({scope:this,success:function(){Rally.getApp().setLoading(!1),e.destroy()},failure:function(e){console.log("cannot remove all the time entry items because they're used elsewhere",e)}}).always((function(){Rally.getApp().setLoading(!1)}))}})},_removeTimeEntryItem:function(e){let t=Ext.create("Deft.Deferred");return e.destroy({callback:function(e,r){r.wasSuccessful()?t.resolve():t.reject(r.error.errors[0])}}),t.promise},getTimeEntryValue:function(e){Ext.Array.indexOf(CA.techservices.timesheet.TimeRowUtils.daysInOrder,e),this.get("WeekStartDate");let t=this.get("TimeEntryValueRecords"),r=null,i=CA.techservices.timesheet.TimeRowUtils.getValueFromDayOfWeek(this.get("WeekStartDate"),this.get("WeekStart"),e);return Ext.Array.each(t,(function(e){Ext.Date.format(i,"y-m-d")===Ext.Date.format(e.get("DateVal"),"y-m-d")&&(r=e)})),r},_createTimeEntryValue:function(e,t){let r=Ext.create("Deft.Deferred"),i=CA.techservices.timesheet.TimeRowUtils.getValueFromDayOfWeek(this.get("WeekStartDate"),this.get("WeekStart"),e),s=null;return Ext.Array.each(this.get("TimeEntryItemRecords"),(function(e){let t=Rally.util.DateTime.getDifference(i,e.get("WeekStartDate"),"day");i>=e.get("WeekStartDate")&&t<7&&(s=e)})),Ext.isEmpty(s)?(console.log("No Time Entry Item"),this._createTimeEntryItem(i,this.get("Project"),this.get("WorkProduct"),this.get("Task")).then({scope:this,success:function(s){if(!this.createTEVProcess[e]||"pending"!==this.createTEVProcess[e].getState())return this.createTEVProcess[e]=this._createTimeEntryValueWithModel(e,t,i,s),this.createTEVProcess[e];console.log("..Save is already in process"),r.resolve()},failure:function(e){console.log("Problem creating new TEI",e),r.reject(e)}}),r.promise):this.createTEVProcess[e]&&"pending"===this.createTEVProcess[e].getState()?void console.log("...Save is already in process",e):(this.createTEVProcess[e]=this._createTimeEntryValueWithModel(e,t,i,s),this.createTEVProcess[e])},_createTimeEntryItem:function(e,t,r,i){Rally.getApp().setLoading("Creating Time Entry Item...");let s=Ext.create("Deft.Deferred"),n=this,a={WeekStartDate:TSDateUtils.getBeginningOfWeekISOForLocalDate(e),Project:{_ref:t._ref}};return Ext.isEmpty(i)||(a.Task={_ref:i._ref}),Ext.isEmpty(r)||(a.WorkProduct={_ref:r._ref}),Rally.data.ModelFactory.getModel({type:"TimeEntryItem",scope:this,success:function(e){Ext.create(e,a).save({callback:function(e){let t=n.get("TimeEntryItemRecords")||[];t.push(e),n.set("TimeEntryItemRecords",t),Rally.getApp().setLoading(!1),s.resolve(e)}})}}),s.promise},_createTimeEntryValueWithModel:function(e,t,r,i){let s=Ext.create("Deft.Deferred"),n=this,a=TSDateUtils.formatShiftedDate(r,"Y-m-d")+"T00:00:00.000Z";return Rally.data.ModelFactory.getModel({type:"TimeEntryValue",scope:this,success:function(r){this._changeFieldRights(r),Ext.create(r,{Hours:t,TimeEntryItem:{_ref:i.get("_ref")},DateVal:a}).save({callback:function(r,i){if(i.wasSuccessful()){this.set(e,t);let i=n.get("TimeEntryValueRecords")||[];i.push(r),n.set("TimeEntryValueRecords",i),n.set("Total",0),s.resolve(r)}else n.set(e,0),console.error("Problem saving Time Entry Value:",e,i),Rally.getApp().showError(`'Problem saving Time Entry Value: ${e}`),s.reject(i.error&&i.error.errors.join("."))}})}}),s.promise},_changeFieldRights:function(e){let t=e.getFields();return Ext.Array.each(t,(function(e,r){"TimeEntryItem"===e.name&&(e.readOnly=!1,e.persist=!0,e.type="string"),"DateVal"===e.name&&(t[r]=Ext.create("Rally.data.wsapi.Field",{type:"string",readOnly:!1,persist:!0,name:"DateVal",custom:!1,hidden:!1,useNull:!1}))})),e},_changeDetailPreference:function(e){let t=this,r=Ext.JSON.encode(e);this.process&&"pending"===this.process.getState()||(this.process=Deft.Chain.sequence([function(){return CA.techservices.timesheet.TimeRowUtils.getDetailPreference(t)}],this).then({success:function(e){if(0===(e=Ext.Array.flatten(e)).length)return;let t=e[0];t.set("Value",r),t.save()},failure:function(e){Ext.Msg.alert("Problem saving detail",e)}}))},addTimeBlock:function(e,t){let r=this.get("_DetailBlocks");Ext.isEmpty(r)&&!Ext.isEmpty(this.get("DetailPreference"))&&(r=Ext.JSON.decode(this.get("DetailPreference").get("Value")),this.set("_DetailBlocks",r));let i=this.getTimeBlocks(e),s=this.getTimeBlock(e,t.id);Ext.isEmpty(s)?i.push(t):Ext.Object.merge(s,t),r[e]=i,this.set("_DetailBlocks",r),this.set("_SecretKey",new Date),this.setDirty()},removeTimeBlock:function(e,t){let r=this.get("_DetailBlocks");Ext.isEmpty(r)&&!Ext.isEmpty(this.get("DetailPreference"))&&(r=Ext.JSON.decode(this.get("DetailPreference").get("Value")),this.set("_DetailBlocks",r));let i=this.getTimeBlocks(e),s=Ext.Array.filter(i,(function(e){return t!==e.id}));r[e]=s,this.set("_DetailBlocks",r),this.set("_SecretKey",new Date),this.setDirty()},getTimeBlock:function(e,t){let r=this.getTimeBlocks(e),i=null;return Ext.Array.each(r,(function(e){e.id===t&&(i=e)})),i},getTimeBlocks:function(e){let t=this.get("_DetailBlocks");return t&&t[e]?t[e]:[]},isPinned:function(){return this.get("Pinned")||!1},_dateIsPrecedingWeek:function(){return new Date>Rally.util.DateTime.add(this.get("WeekStartDate"),"week",1)},_dateIsPrecedingMonth:function(e){let t=new Date;return!(e.getYear()>t.getYear()||e.getMonth()>t.getMonth())&&(e.getMonth()!==t.getMonth()&&(e.getMonth()<t.getMonth()-1||(t.getDate()>1||(t.getHours()>12||12===t.getHours()&&t.getMinutes()>5))))},hasOpenDetails:function(){let e=!1,t=this.get("_DetailBlocks");return Ext.Object.each(t,(function(t,r){Ext.Array.each(r,(function(t){Ext.isEmpty(t.end_hour)&&(e=!0)}))})),e}});
                Ext.override(Rally.ui.grid.plugin.Validation,{_onBeforeEdit:function(){}}),Ext.define("CA.techservices.TimeTable",{extend:"Ext.Container",alias:"widget.tstimetable",rows:[],cls:"tstimetable",time_entry_item_fetch:["WeekStartDate","WorkProductDisplayString","WorkProduct","Task","TaskDisplayString","PortfolioItem","Project","ObjectID","Name","Release","ReleaseDate","FormattedID","Iteration","ToDo","State","Rank","Defect","Estimate","Priority","c_Priority"],config:{startDate:null,editable:!0,timesheetUser:null,pinKey:"CA.techservices.timesheet.pin",showEditTimeDetailsMenuItem:!1,pickableColumns:null,maxRows:null,lowestLevelPIName:null},constructor:function(e){if(this.mergeConfig(e),Ext.isEmpty(e.startDate)||!Ext.isDate(e.startDate))throw"CA.techservices.TimeTable requires startDate parameter (JavaScript Date)";this.weekStart=CA.techservices.timesheet.TimeRowUtils.getDayOfWeekFromDate(this.startDate)||0,this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.addEvents("gridReady"),Ext.isEmpty(this.timesheetUser)&&(this.timesheetUser=Rally.getApp().getContext().getUser()),this.startDate=TSDateUtils.pretendIMeantUTC(this.startDate),Ext.isEmpty(this.lowestLevelPIName)||this.time_entry_item_fetch.push(this.lowestLevelPIName),TSUtilities.fetchField("Task","State").then({success:function(e){this.taskState=e,this._updateData()},failure:function(e){Ext.Msg.alert("Problem Initiating TimeSheet App",e)},scope:this})},_updateData:function(){this.setLoading("Loading time...");this.maxRows=48,Deft.Chain.sequence([this._loadTimeEntryItems,this._loadTimeEntryValues,this._loadTimeDetailPreferences,this._loadDefaultSettings],this).then({scope:this,success:function(e){let t=e[0],r=e[1],a=e[2];this.time_entry_defaults=e[3],this.rows=this._createRows(t,r,a),this._makeGrid(this.rows),this.setLoading(!1)},failure:function(e){Ext.Msg.alert("Problem Loading",e)}})},_loadDefaultSettings:function(){let e=Ext.create("Deft.Deferred");return Rally.data.PreferenceManager.load({filterByUser:!0,additionalFilters:[{property:"Name",operator:"contains",value:this.pinKey}],success:function(t){let r={};Ext.Object.each(t,(function(e,t){let a=Ext.JSON.decode(t);Ext.apply(r,a)})),e.resolve(r)}}),e.promise},_makeGrid:function(e){this.removeAll();let t=this,r=Ext.create("Rally.data.custom.Store",{model:"CA.techservices.timesheet.TimeRow",data:e,pageSize:t.maxRows,remoteSort:!1,sortOnFither:!0,sortOnLoad:!0,sorters:[{property:this.sortedColumn,direction:this.sortDirection}]});this.grid=this.add({xtype:"rallygrid",store:r,columnCfgs:this._getColumns(),showPagingToolbar:!1,showRowActionsColumn:!1,disableSelection:!0,enableColumnMove:!1,enableColumnResize:!1,features:[{ftype:"summary",dock:"top"}],listeners:{sortchange:function(e,r,a){this.sortedColumn=r.dataIndex,this.sortDirection=a,t.fireEvent("sortchange",this,r.dataIndex,a)}},viewConfig:{listeners:{itemupdate:function(){}}}}),this.fireEvent("gridReady",this,this.grid)},_getRowActions:function(e){let t=this,r=[{xtype:"rallyrecordmenuitem",text:"Set as Default",predicate:function(){return!this.record.isPinned()},handler:function(e){t._pinRecord(e.record)},record:e},{xtype:"rallyrecordmenuitem",text:"Unset Default",predicate:function(){return this.record.isPinned()},handler:function(e){t._unpinRecord(e.record)},record:e},{xtype:"rallyrecordmenuitem",text:"Clear",record:e,predicate:function(){return t.editable},handler:function(e){let r=e.record;0<r.get("Total")?Ext.MessageBox.confirm("Clear Row","You have hours entered for this row. Are you sure?",(function(e){"yes"===e&&(Ext.Array.remove(t.rows,r),r.clearAndRemove())})):(Ext.Array.remove(t.rows,r),r.clearAndRemove())}}];return t.showEditTimeDetailsMenuItem&&r.push({xtype:"rallyrecordmenuitem",text:"Edit Time",record:e,handler:function(e){let r=e.record;t._launchTimeDetailsDialog(r)}}),r},setPickableColumns:function(e){let t=Ext.Array.merge([],this._getBaseLeftColumns());t=Ext.Array.merge(t,e),t=Ext.Array.merge(t,this._getBaseRightColumns());let r=this.getGrid().getStore();this.getGrid().reconfigure(r,t)},_getColumns:function(){let e=Ext.Array.merge([],this._getBaseLeftColumns());return e=Ext.Array.merge(e,this.getPickableColumns()),e=Ext.Array.merge(e,this._getBaseRightColumns()),e},getRankValue:function(e,t){let r=t&&t.treeStore||t,a=r&&r.getSorters(),i=a&&a[1];if(i&&Rally.data.Ranker.isRankField(i.property)){let t=r.indexOf(e);if(-1!==t){let e=r.currentPage?r.currentPage:1,a=r.pageSize*(e-1);return"ASC"===i.direction?t+a+1:r.getTotalCount()-a-t}}return""},getPickableColumns:function(){let e=[],t=this;e.push({dataIndex:"Project",text:"Project",flex:1,editor:null,sortable:!0,hidden:!1,menuDisabled:!0,renderer:function(e,t,r){return e<0?"--":r.get("Project").Name}}),e.push({dataIndex:"WorkProductOID",text:"Work Item",flex:1,editor:null,sortable:!0,menuDisabled:!0,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>: {2}",Rally.nav.Manager.getDetailUrl(r.get("WorkProduct")),r.get("WorkProduct").FormattedID,r.get("WorkProduct").Name)}}),e.push({dataIndex:"WorkProductFID",text:"Work Item ID",flex:1,editor:null,hidden:!0,menuDisabled:!0,sortable:!0,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(r.get("WorkProduct")),r.get("WorkProduct").FormattedID)}}),e.push({dataIndex:"WorkProductName",text:"Work Item Name",hidden:!0,flex:1,editor:null,menuDisabled:!0,sortable:!0});let r={dataIndex:"WorkProductState",text:"Defect State",sortable:!0,field:"WorkProduct",menuDisabled:!0,getEditor:function(e){return"Defect"===e.get("WorkProduct")._type&&Ext.create("Ext.grid.CellEditor",{field:Ext.create("Rally.ui.combobox.FieldValueComboBox",{xtype:"rallyfieldvaluecombobox",model:"Defect",field:"State",value:e.get("WorkProduct").State,listeners:{change:function(t,r){Ext.isEmpty(r)||(e.set("WorkProduct".State,r),e.save())}}})})}};e.push(r),Ext.isEmpty(this.lowestLevelPIName)?(e.push({dataIndex:"PortfolioItemOID",text:"Portfolio Item",flex:1,editor:null,sortable:!0,hidden:!0,menuDisabled:!0,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>: {2}",Rally.nav.Manager.getDetailUrl(r.get("PortfolioItem")),r.get("PortfolioItem").FormattedID,r.get("PortfolioItem").Name)}}),e.push({dataIndex:"PortfolioItemFID",text:"Portfolio Item ID",flex:1,editor:null,hidden:!0,menuDisabled:!0,sortable:!0,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(r.get("PortfolioItem")),r.get("PortfolioItem").FormattedID)}}),e.push({dataIndex:"PortfolioItemName",text:"PortfolioItem Name",hidden:!0,flex:1,editor:null,menuDisabled:!0,sortable:!0})):(e.push({dataIndex:"PortfolioItemOID",text:this.lowestLevelPIName,flex:1,editor:null,sortable:!0,hidden:!0,menuDisabled:!0,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>: {2}",Rally.nav.Manager.getDetailUrl(r.get("PortfolioItem")),r.get("PortfolioItem").FormattedID,r.get("PortfolioItem").Name)}}),e.push({dataIndex:"PortfolioItemFID",text:this.lowestLevelPIName+" ID",flex:1,editor:null,hidden:!0,menuDisabled:!0,sortable:!0,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(r.get("PortfolioItem")),r.get("PortfolioItem").FormattedID)}}),e.push({dataIndex:"PortfolioItemName",text:this.lowestLevelPIName+" Name",hidden:!0,flex:1,editor:null,menuDisabled:!0,sortable:!0})),e.push({dataIndex:"Release",text:"Release",width:150,editor:null,sortable:!1,menuDisabled:!0,renderer:function(e){return Ext.isEmpty(e)?"--":e._refObjectName}}),e.push({dataIndex:"Iteration",text:"Iteration",width:150,editor:null,sortable:!1,menuDisabled:!0,renderer:function(e){return Ext.isEmpty(e)?"--":e._refObjectName}}),e.push({dataIndex:"TaskOID",text:"Task",sortable:!0,flex:1,menuDisabled:!0,editor:null,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>: {2}",Rally.nav.Manager.getDetailUrl(r.get("Task")),r.get("Task").FormattedID,r.get("Task").Name)}}),e.push({dataIndex:"TaskFID",text:"Task ID",sortable:!0,flex:1,hidden:!0,menuDisabled:!0,editor:null,renderer:function(e,t,r){return e<0?"--":Ext.String.format("<a target='_top' href='{0}'>{1}</a>",Rally.nav.Manager.getDetailUrl(r.get("Task")),r.get("Task").FormattedID)}}),e.push({dataIndex:"TaskName",text:"Task Name",sortable:!0,flex:1,hidden:!0,menuDisabled:!0,editor:null});let a={dataIndex:"State",text:"State",resizable:!1,align:"left",field:"test",sortable:!0,menuDisabled:!0,getEditor:function(e){return!Ext.isEmpty(e.get("Task"))&&Ext.create("Ext.grid.CellEditor",{field:Ext.create("Rally.ui.combobox.FieldValueComboBox",{xtype:"rallyfieldvaluecombobox",model:"Task",field:"State",value:e.get("Task").State,listeners:{change:function(t,r){Ext.isEmpty(r)||(e.set("State",r),e.save())}}})})},renderer:function(e,r,a){if(Ext.isEmpty(a.get("Task")))return"--";return Ext.create("Rally.ui.renderer.template.ScheduleStateTemplate",{field:t.taskState}).apply(a.get("Task"))}};e.push(a);let i={dataIndex:"ToDo",text:"To Do",width:50,resizable:!1,align:"center",field:"test",sortable:!0,menuDisabled:!0,summaryType:"sum",getEditor:function(e){if(Ext.isEmpty(e.get("Task")))return!1;return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Rally.ui.NumberField",{xtype:"rallynumberfield",minValue:0,selectOnFocus:!0,listeners:{change:function(t,r){Ext.isEmpty(r)&&t.setValue(0),e.set("ToDo",r),e.save()}}})})},renderer:function(e,t){return t.tdCls="ts-right-border",e>0?e:""}};if(e.push(i),!this.pickableColumns)return e;let o={};return Ext.Array.each(this.pickableColumns,(function(e){o[e.dataIndex]=e})),Ext.Array.map(e,(function(e){let t=o[e.dataIndex];return Ext.isEmpty(t)||(t.hidden?e.hidden=!0:e.hidden=!1),e}))},_getBaseLeftColumns:function(){let e=this;return[{xtype:"rallyrowactioncolumn",sortable:!1,scope:e,rowActionsFn:function(t){return e._getRowActions(t)}},{text:" ",width:25,dataIndex:"__SecretKey",renderer:function(e,t,r){let a="";return r.hasOpenDetails()&&(a+="<span class='icon-calendar'></span>"),a}}]},_getBaseRightColumns:function(){let e=[];Ext.Array.each(CA.techservices.timesheet.TimeRowUtils.getOrderedDaysBasedOnWeekStart(this.weekStart),(function(t,r){e.push(this._getColumnForDay(t,r))}),this);return e.push({dataIndex:"Total",text:"Total",width:50,resizable:!1,align:"center",editor:null,summaryType:"sum",renderer:function(e,t){return t.tdCls="ts-total-cell",e}}),e},_getItemOIDFromRow:function(e){return(e.get("Task")||e.get("WorkProduct")).ObjectID},_unpinRecord:function(e){e.set("Pinned",!1);let t=this._getItemOIDFromRow(e),r=Ext.String.format("{0}.{1}",this.pinKey,t),a={},i={};i[t]=!1,a[r]=Ext.JSON.encode(i),Rally.data.PreferenceManager.update({user:Rally.getApp().getContext().getUser().ObjectID,filterByUser:!0,settings:a})},_pinRecord:function(e){e.set("Pinned",!0);let t=e.get("Task")||e.get("WorkProduct"),r=this._getItemOIDFromRow(e),a=Ext.String.format("{0}.{1}",this.pinKey,r),i={},o={};o[r]=t._type,i[a]=Ext.JSON.encode(o),Rally.data.PreferenceManager.update({user:Rally.getApp().getContext().getUser().ObjectID,filterByUser:!0,settings:i})},_getColumnForDay:function(e,t){let r=this,a=new Date,i=Rally.util.DateTime.add(this.startDate,"week",1),o=a.getDay(),n=CA.techservices.timesheet.TimeRowUtils.getOrderedDaysBasedOnWeekStart(0),s=moment(this.startDate).utc().add(t,"day").utc(),l=Rally.util.DateTime.add(s.toDate(),"hour",12),d=Ext.String.format("{0}<br/>{1}",CA.techservices.timesheet.TimeRowUtils.dayShortNames[e],s.format("D MMM")),u={dataIndex:e,html:d,width:50,resizable:!1,sortable:!0,align:"center",getEditor:function(t){const a=t.get&&t.get("Release")||t.Release;return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Rally.ui.NumberField",{minValue:0,maxValue:36,disabled:!r.editable||a&&a.ReleaseDate&&new Date(a.ReleaseDate)<l&&!Rally.getApp().isTimeSheetAdmin(),selectOnFocus:!0}),listeners:{complete:function(r,a){Ext.isEmpty(a)&&(a=0,r.setValue(a)),t.set(e,a),t.save()}}})},field:"test",summaryType:"sum",renderer:function(e,t,r){const a=r.get&&r.get("Release")||r.Release;return a&&a.ReleaseDate&&new Date(a.ReleaseDate)<l&&!Rally.getApp().isTimeSheetAdmin()&&(t.tdCls="ts-disabled-cell"),0===e?"":e},summaryRenderer:function(e){return 0===e?"":Ext.util.Format.number(e,"0.00")}};return e===n[o]&&this.startDate<a&&a<i&&(u.renderer=function(e,t){return t.tdCls="ts-total-cell",0===e?"":e}),"Saturday"===e||"Sunday"===e?u.renderer=function(e,t){return t.tdCls="ts-weekend-cell",0===e?"":e}:r.editable||(u.renderer=function(e,t){return t.tdCls="ts-disabled-cell",0===e?"":e}),u},_getTimeEntryItemSets:function(e){let t={};return Ext.Array.each(e,(function(e){let r=e.get("Task")&&e.get("Task").ObjectID;Ext.isEmpty(r)&&(r=e.get("WorkProduct")&&e.get("WorkProduct").ObjectID),Ext.isEmpty(r)&&(r=e.get("Project")&&e.get("Project").ObjectID),Ext.isEmpty(t[r])&&(t[r]=[]),t[r].push(e)})),Ext.Object.getValues(t)},_createRows:function(e,t,r){let a=[],i=this,o=this._getTimeEntryItemSets(e);return Ext.Array.each(o,(function(e){let o=[];Ext.Array.each(e,(function(e){let r=e.get("ObjectID"),a=Ext.Array.filter(t,(function(e){return e.get("TimeEntryItem").ObjectID==r}));o=Ext.Array.push(o,a)}));let n=CA.techservices.timesheet.TimeRowUtils.getItemOIDFromTimeEntryItem(e[0]),s=null;Ext.Array.each(r,(function(e){let t=e.get("Name").split(".");""+n==t[t.length-1]&&(s=e)})),Ext.isEmpty(i.lowestLevelPIName)||Ext.Object.each(e,(function(e,t){if(t.get("WorkProduct")&&t.get("WorkProduct")[i.lowestLevelPIName]){let e=t.get("WorkProduct");e.PortfolioItem=t.get("WorkProduct")[i.lowestLevelPIName],t.set("WorkProduct",e)}}));let l={WeekStartDate:i.startDate,TimeEntryItemRecords:e,TimeEntryValueRecords:o};Ext.isEmpty(s)||(l.DetailPreference=s),i.time_entry_defaults[n]&&!1!==i.time_entry_defaults[n]&&(l.Pinned=!0);let d=Ext.create("CA.techservices.timesheet.TimeRow",l);a.push(d)})),a},addRowForItem:function(e){let t=this;if(this._hasRowForItem(e))return;let r=e.get("_type"),a=TSDateUtils.getBeginningOfWeekISOForLocalDate(t.startDate),i={WorkProduct:{_ref:e.get("_ref")},WeekStartDate:a,User:{_ref:"/usr/"+this.timesheetUser.ObjectID}};e.get("Project")&&(i.Project=e.get("Project")),"task"===r&&(i.Task={_ref:e.get("_ref")},i.WorkProduct={_ref:e.get("WorkProduct")._ref}),Rally.data.ModelFactory.getModel({type:"TimeEntryItem",scope:this,success:function(e){Ext.create(e,i).save({fetch:t.time_entry_item_fetch,callback:function(e,r,a){if(!a)return void Rally.getApp().showError(`Error creating Time Entry Item: ${r.error?.errors?.join()||"Unknown Error"}`);let i=Ext.create("CA.techservices.timesheet.TimeRow",{WeekStartDate:t.startDate,TimeEntryItemRecords:[e],TimeEntryValueRecords:[]}),o=t._getItemOIDFromRow(i);t.time_entry_defaults[o]&&!1!==t.time_entry_defaults[o]&&i.set("Pinned",!0),t.grid.getStore().loadRecords([i],{addRecords:!0}),t.rows.push(i),t.grid.refresh()}})}})},getGrid:function(){return this.grid},_hasRowForItem:function(e){let t=this.rows,r=!1,a=e.get("_type");return Ext.Array.each(t,(function(t){t&&("task"===a?t.get("Task")&&t.get("Task")._ref===e.get("_ref")&&(r=!0):Ext.isEmpty(t.get("Task"))&&t.get("WorkProduct")&&t.get("WorkProduct")._ref===e.get("_ref")&&(r=!0))})),r},_launchTimeDetailsDialog:function(e){Ext.create("CA.technicalservices.TimeDetailsDialog",{row:e})},_loadTimeEntryItems:function(){this.setLoading("Loading time entry items...");let e=[{property:"User.ObjectID",value:this.timesheetUser.ObjectID}];0===this.weekStart?e.push({property:"WeekStartDate",value:this.startDate}):(e.push({property:"WeekStartDate",operator:">=",value:Rally.util.DateTime.add(this.startDate,"day",-6)}),e.push({property:"WeekStartDate",operator:"<=",value:Rally.util.DateTime.add(this.startDate,"day",6)}));let t={model:"TimeEntryItem",context:{project:null},fetch:this.time_entry_item_fetch,enableRankFieldParameterAutoMapping:!1,filters:e,sorters:[{property:"ProjectDisplayString",direction:"ASC"}],limit:2*this.maxRows,pageSize:2*this.maxRows};return TSUtilities.loadWsapiRecords(t)},_loadTimeEntryValues:function(){this.setLoading("Loading time entry values...");let e=[{property:"TimeEntryItem.User.ObjectID",value:this.timesheetUser.ObjectID}];0===this.weekStart?e.push({property:"TimeEntryItem.WeekStartDate",value:this.startDate}):(e.push({property:"TimeEntryItem.WeekStartDate",operator:">=",value:Rally.util.DateTime.add(this.startDate,"day",-6)}),e.push({property:"TimeEntryItem.WeekStartDate",operator:"<=",value:Rally.util.DateTime.add(this.startDate,"day",6)}));let t={model:"TimeEntryValue",context:{project:null},fetch:["DateVal","Hours","TimeEntryItem","ObjectID"],filters:e,pageSize:2e3,limit:"Infinity"};return TSUtilities.loadWsapiRecords(t)},_loadTimeDetailPreferences:function(){this.setLoading("Loading time entry details...");let e={model:"Preference",fetch:["Name","Value"],filters:[{property:"Name",operator:"contains",value:CA.techservices.timesheet.TimeRowUtils.getDetailPrefix(this.startDate)}],context:{project:null}};return TSUtilities.loadWsapiRecords(e)}});
                Ext.define("TSTimesheet",{extend:"Rally.app.App",componentCls:"app",defaults:{margin:10},layout:"border",items:[{xtype:"container",itemId:"selector_box",region:"north",layout:{type:"hbox"},minHeight:25}],pickableColumns:null,sortedColumn:null,direction:"",portfolioItemTypes:[],stateful:!0,stateEvents:["columnschosen","columnmoved","columnresize","sortchange"],stateId:"CA.technicalservices.timesheet.Settings.4",config:{defaultSettings:{weekStartsOn:0,showAddMyStoriesButton:!1,showEditTimeDetailsMenuItem:!1,showTaskStateFilter:!1,timesheetSupportEmail:""}},async launch(){try{this.currentUserTimeSheetAdmin=await TSUtilities.getCurrentUserIsTimeSheetAdmin(),this.portfolioItemTypes=await TSUtilities.fetchPortfolioItemTypes(),this._addSelectors(this.down("#selector_box"))}catch(e){this.showError(e,"Problem Initiating TimeSheet App")}},_getLowestLevelPIName:function(){return this.portfolioItemTypes[0].get("Name")},_addSelectors:function(e){e.removeAll(),e.add({xtype:"container",itemId:"add_button_box"});const t=e.add({xtype:"container",flex:1,layout:{type:"hbox",align:"middle",pack:"center"}});let a=this.getSetting("weekStartsOn");this.isTimeSheetAdmin()?t.add({xtype:"rallyusersearchcombobox",includeWorkspaceUsers:!0,context:this.getContext(),fieldLabel:"Select user",labelWidth:65,width:275,itemId:"userCombo",id:"userCombo",margin:"0 10 0 10",listeners:{change(){this.updateData()},scope:this}}):t.add({xtype:"container",itemId:"messageContainer",tpl:'<tpl if="msg"><div>{msg}</div></tpl>'}),e.add({xtype:"tsarroweddate",itemId:"date_selector",fieldLabel:"Week Starting",listeners:{scope:this,change:function(e,t){if(Ext.isEmpty(t))return;let i=TSDateUtils.getBeginningOfWeekForLocalDate(t,a);i!==t&&e.setValue(i),t.getDay()===a&&this.updateData()}}}).setValue(new Date)},_addAddButtons:function(e){e.removeAll(),e.add({xtype:"rallybutton",text:"Add My Tasks",toolTipText:"(in current iteration + defaults)",padding:2,disabled:!1,listeners:{scope:this,click:this._addCurrentTasksAndDefaults}}),this.getSetting("showAddMyStoriesButton")&&e.add({xtype:"rallybutton",text:"Add My Stories",toolTipText:"Add my stories and stories with my tasks",disabled:!1,listeners:{scope:this,click:this._addCurrentStories}}),e.add({xtype:"rallybutton",text:'+<span class="icon-task"> </span>',disabled:!1,toolTipText:"Search and add Tasks",listeners:{scope:this,click:this._findAndAddTask}}),e.add({xtype:"rallybutton",text:'+<span class="icon-story"> </span>',toolTipText:"Search and add User Stories",disabled:!1,listeners:{scope:this,click:this._findAndAddStory}}),this.getSetting("showTaskStateFilter")&&e.add({xtype:"rallyfieldvaluecombobox",model:"Task",field:"State",fieldLabel:"State:",labelAlign:"right",stateful:!0,stateId:"task-state-filter-combo",multiSelect:!0,value:["Defined","In-Progress","Completed"],listeners:{scope:this,change:this._filterState}})},_filterState:function(e){let t=this.down("tstimetable"),a=new Ext.util.Filter({filterFn:function(t){return Ext.Array.contains(e.value,t.get("State"))||!t.get("State")}});e.value.length>0?t.grid.filter(a):t.grid.filter(null,!0)},_addCurrentStories:function(){let e=this.down("tstimetable");if(!e)return;this.setLoading("Finding my current stories...");let t=Rally.data.wsapi.Filter.or([{property:"Owner.ObjectID",value:this.getContext().getUser().ObjectID},{property:"Tasks.Owner.ObjectID",value:this.getContext().getUser().ObjectID}]),a={model:"HierarchicalRequirement",context:{project:null},fetch:["ObjectID","Name","FormattedID","WorkProduct","Project"],filters:Rally.data.wsapi.Filter.and([{property:"Iteration.StartDate",operator:"<=",value:Rally.util.DateTime.toIsoString(this.startDate)},{property:"Iteration.EndDate",operator:">=",value:Rally.util.DateTime.toIsoString(this.startDate)},{property:"Release.ReleaseDate",operator:">=",value:Rally.util.DateTime.toIsoString(this.startDate)}]).and(t)};TSUtilities.loadWsapiRecords(a).then({scope:this,success:function(t){let a=t.length;e.getGrid().getStore().getTotalCount()+a>this.getSetting("maxRows")?(Ext.Msg.alert("Problem Adding Items","Cannot add items to grid. Limit is "+this.getSetting("maxRows")+" lines in the time sheet."),this.setLoading(!1)):Ext.Array.each(t,(function(t){e.addRowForItem(t)})),this.setLoading(!1)},failure:function(e){Ext.Msg.alert("Problem with my stories",e)}})},_addCurrentTasksAndDefaults:function(){let e=this;Deft.Chain.sequence([this._addCurrentTasks,this._addDefaults],this).then({failure:function(e){Ext.Alert.msg("Problem adding current items",e)}}).always((function(){e.setLoading(!1)}))},_addDefaults:function(){let e=this.down("tstimetable"),t=this;if(!e)return;let a=e.time_entry_defaults,i=[];return this.setLoading("Finding my defaults..."),Ext.Object.each(a,(function(a,s){s&&i.push((function(){let i=Ext.create("Deft.Deferred"),r={model:s,context:{project:null},fetch:["ObjectID","Name","FormattedID","WorkProduct","Project","Release","ReleaseDate"],filters:[{property:"ObjectID",value:a}]};return TSUtilities.loadWsapiRecords(r).then({scope:this,success:function(a){let s=a.length;e.getGrid().getStore().getTotalCount()+s>t.getSetting("maxRows")?(Ext.Msg.alert("Problem Adding Items","Cannot add items to grid. Limit is "+t.getSetting("maxRows")+" lines in the time sheet."),t.setLoading(!1)):Ext.Array.each(a,(function(a){t.recordIsInPastRelease(a)&&!t.isTimeSheetAdmin()?t.showError(`${a.get("FormattedID")} is in a past Release. Time cannot be charged against it`):e.addRowForItem(a)})),t.setLoading(!1),i.resolve(a)},failure:function(e){i.reject(e)}}),i.promise}))})),Deft.Chain.sequence(i)},_addCurrentTasks:function(){let e=this,t=Ext.create("Deft.Deferred"),a=this.down("tstimetable");if(!a)return;this.setLoading("Finding my current tasks...");let i={model:"Task",context:{project:null},fetch:["ObjectID","Name","FormattedID","WorkProduct","Project"],filters:[{property:"Owner.ObjectID",value:this.getContext().getUser().ObjectID},{property:"Iteration.StartDate",operator:"<=",value:Rally.util.DateTime.toIsoString(this.startDate)},{property:"Iteration.EndDate",operator:">=",value:Rally.util.DateTime.toIsoString(this.startDate)},{property:"Release.ReleaseDate",operator:">=",value:Rally.util.DateTime.toIsoString(this.startDate)},{property:"State",operator:"!=",value:"Completed"}]};return TSUtilities.loadWsapiRecords(i).then({scope:this,success:function(i){let s=i.length;a.getGrid().getStore().getTotalCount()+s>e.getSetting("maxRows")?(Ext.Msg.alert("Problem Adding Items","Cannot add items to grid. Limit is "+e.getSetting("maxRows")+" lines in the time sheet."),this.setLoading(!1)):Ext.Array.each(i,(function(e){a.addRowForItem(e)})),this.setLoading(!1),t.resolve(i)},failure:function(e){t.reject(e)}}),t.promise},_findAndAddTask:function(){let e=this,t=this.down("tstimetable"),a=[{property:"State",operator:"!=",value:"Completed"}],i=["WorkProduct","Feature","Release","ReleaseDate","Project","Name","FormattedID","ObjectID"],s="Choose Task(s)";if(!this.isTimeSheetAdmin()){let e=Ext.create("Rally.data.QueryFilter",{property:"Release.ReleaseDate",operator:">=",value:Rally.util.DateTime.toIsoString(this.startDate)});e=e.or({property:"Release",value:null}),a.push(e),s+=" - Tasks in past Releases will not be shown"}t&&Ext.create("Rally.technicalservices.ChooserDialog",{artifactTypes:["task"],autoShow:!0,multiple:!0,width:1500,title:s,context:{project:null},storeConfig:{filters:a},filterableFields:[{displayName:"Formatted ID",attributeName:"FormattedID"},{displayName:"Name",attributeName:"Name"},{displayName:"WorkProduct",attributeName:"WorkProduct.Name"},{displayName:"Project",attributeName:"Project.Name"},{displayName:"Owner",attributeName:"Owner"},{displayName:"State",attributeName:"State"}],columns:[{text:"ID",dataIndex:"FormattedID"},"Name","WorkProduct","Iteration","Release","Project","Owner","State"],fetchFields:i,listeners:{artifactchosen:function(a,i){Ext.isArray(i)||(i=[i]);let s=i.length;t.getGrid().getStore().getTotalCount()+s>e.getSetting("maxRows")?Ext.Msg.alert("Problem Adding Tasks","Cannot add items to grid. Limit is "+e.getSetting("maxRows")+" lines in the time sheet."):Ext.Array.each(i,(function(a){e.recordIsInPastRelease(a)&&!e.isTimeSheetAdmin()?e.showError(`${a.get("FormattedID")} is in a past Release. Time cannot be charged against it`):t.addRowForItem(a)}))},scope:this}})},_findAndAddStory:function(){let e=this,t="Choose Work Product(s)",a=this.down("tstimetable"),i=Ext.create("Rally.data.QueryFilter",{property:"ScheduleState",operator:"=",value:"Requested"});if(i=i.or({property:"ScheduleState",operator:"=",value:"Defined"}),i=i.or({property:"ScheduleState",operator:"=",value:"In-Progress"}),i=i.and({property:"DirectChildrenCount",operator:"=",value:0}),!this.isTimeSheetAdmin()){let e=Ext.create("Rally.data.QueryFilter",{property:"Release.ReleaseDate",operator:">=",value:Rally.util.DateTime.toIsoString(this.startDate)});e=e.or({property:"Release",value:null}),i=i.and(e),t+=" - Stories in past Releases will not be shown"}a&&Ext.create("Rally.technicalservices.ChooserDialog",{artifactTypes:["hierarchicalrequirement","defect"],autoShow:!0,title:t,multiple:!0,width:1500,storeConfig:{filters:i},filterableFields:[{displayName:"Formatted ID",attributeName:"FormattedID"},{displayName:"Name",attributeName:"Name"},{displayName:"Project",attributeName:"Project.Name"},{displayName:"Owner",attributeName:"Owner"}],columns:[{text:"ID",dataIndex:"FormattedID"},"Name","Release","Iteration","Project","Owner","ScheduleState"],fetchFields:["WorkProduct","Feature","Project","Name","FormattedID","ObjectID","Release","ReleaseDate"],listeners:{artifactchosen:function(t,i){Ext.isArray(i)||(i=[i]);let s=i.length;a.getGrid().getStore().getTotalCount()+s>e.getSetting("maxRows")?Ext.Msg.alert("Problem Adding Stories","Cannot add items to grid. Limit is "+e.getSetting("maxRows")+" lines in the time sheet."):Ext.Array.each(i,(function(t){e.recordIsInPastRelease(t)&&!e.isTimeSheetAdmin()?e.showError(`${t.get("FormattedID")} is in a past Release. Time cannot be charged against it`):a.addRowForItem(t)}))},scope:this}})},updateData:function(){let e,t=this.down("tstimetable"),a=this.down("#userCombo")&&this.down("#userCombo").getRecord();this.startDate=this.down("#date_selector").getValue();const i=!(new Date>Rally.util.DateTime.add(this.startDate,"week",1))||this.isTimeSheetAdmin(),s=this.down("#messageContainer");if(Ext.isEmpty(t)||t.destroy(),e=a&&a.get("ObjectID")?a.getData():this.getContext().getUser(),s)if(i)s.update({msg:""});else{let e="The selected timesheet is in the past and cannot be edited";this.getSetting("timesheetSupportEmail")&&(e+=`. For timesheet adjustments, please contact ${this.getSetting("timesheetSupportEmail")}`),s.update({msg:e})}i?this.down("#add_button_box").show():this.down("#add_button_box").hide(),this.time_table=this.add({xtype:"tstimetable",region:"center",layout:"fit",margin:15,timesheetUser:e,pickableColumns:this.pickableColumns,sortedColumn:this.sortedColumn,sortDirection:this.sortDirection,lowestLevelPIName:this._getLowestLevelPIName(),startDate:this.startDate,editable:i,maxRows:this.getSetting("maxRows"),showEditTimeDetailsMenuItem:!1,listeners:{scope:this,gridReady:function(){this._addAddButtons(this.down("#add_button_box"))},sortchange:function(e,t,a){this.sortedColumn=t,this.sortDirection=a,this.fireEvent("sortchange",this,t,a)}}})},isTimeSheetAdmin(){return this.currentUserTimeSheetAdmin},recordIsInPastRelease(e){return e.get("Release")&&new Date(e.get("Release").ReleaseDate)<this.startDate},getSettingsFields:function(){let e="5 0 5 0";const t={labelWidth:175,width:350};return[{...t,name:"weekStartsOn",xtype:"rallycombobox",fieldLabel:"Week Starts On",labelAlign:"left",displayField:"Name",valueField:"Value",value:this.getSetting("weekStartsOn"),store:Ext.create("Rally.data.custom.Store",{data:[{Name:"Sunday",Value:0},{Name:"Monday",Value:1},{Name:"Tuesday",Value:2},{Name:"Wednesday",Value:3},{Name:"Thursday",Value:4},{Name:"Friday",Value:5},{Name:"Saturday",Value:6}]}),readyEvent:"ready"},{...t,xtype:"rallynumberfield",name:"maxRows",labelAlign:"left",maxValue:1e3,minValue:10,fieldLabel:"Maximum number of rows",value:this.getSetting("maxRows")||100},{...t,xtype:"rallytextfield",name:"timesheetSupportEmail",fieldLabel:"Timesheet Support Email"},{name:"showTaskStateFilter",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:e,boxLabel:'Show the Task State Filter<br/><span style="color:#999999;"><i>User can limit display of tasks to ones in particular states (does not affect other object types).</i></span>'},{name:"showAddMyStoriesButton",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:e,boxLabel:'Show the Add My Stories Button<br/><span style="color:#999999;"><i>User can add stories in a current sprint that they own or that have tasks they own (does not look for default items).</i></span>'}]},getState:function(){return{pickableColumns:this.pickableColumns,sortedColumn:this.sortedColumn,sortDirection:this.sortDirection}},isExternal:function(){return void 0===this.getAppId()},onSettingsUpdate:function(){this.launch()},showError(e,t){Rally.ui.notify.Notifier.showError({message:this.parseError(e,t)})},parseError(e,t){if(t=t||"An unknown error has occurred","string"==typeof e&&e.length)return e;if(e.message&&e.message.length)return e.message;if(e.exception&&e.error&&e.error.errors&&e.error.errors.length){if(e.error.errors[0].length)return e.error.errors[0];if(e.error&&e.error.response&&e.error.response.status)return`${t} (Status ${e.error.response.status})`}return e.exceptions&&e.exceptions.length&&e.exceptions[0].error?e.exceptions[0].error.statusText:e.exception&&e.error&&"string"==typeof e.error.statusText&&!e.error.statusText.length&&e.error.status&&524===e.error.status?"The server request has timed out":t}});

            Rally.launchApp('TSTimesheet', {
                name:"Rally Enhanced Timesheet",
                parentRepos:"",
                version:"0.2.0"
            });

        });
    </script>


    <style type="text/css">
        .x-btn-tsnav-small {
  background-image: none;
  background-color: white;
  border-color: white !important;
  text-decoration: none;
}
.no-border {
  border-style: none;
  color: red !important;
  background-color: white !important ;
}
.no-border .x-btn-inner {
  color: red !important;
  background-color: white !important ;
}
td.ts-total-cell,
td.ts-disabled-cell {
  background-color: #eee !important;
}
.x-grid-row-summary {
  background-color: #eee;
}
.x-grid-row-alt .x-grid-td {
  background-color: #fff;
}
.x-border-layout-ct {
  background-color: #ffffff;
}
td.ts-weekend-cell {
  background-color: #B0E0E6 !important;
}
span.red {
  color: red;
}
td.ts-right-border {
  border-style: solid;
  border-right: thick double #aaa;
}
.x-item-disabled,
.x-item-disabled * {
  cursor: not-allowed !important;
}

    </style>
</head>
<body>
</body>
</html>
